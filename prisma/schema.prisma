// ============================================================
// BABY SPA - PRISMA SCHEMA
// Sistema de Gestión para Spa de Bebés (Bolivia & Brasil)
// ============================================================

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  OWNER // Socios - acceso total al sistema
  ADMIN // Administrador contratado - operaciones + finanzas limitadas
  RECEPTION // Recepcionista - operaciones diarias
  THERAPIST // Terapeuta - solo su agenda
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BirthType {
  NATURAL
  CESAREAN
}

enum AppointmentStatus {
  PENDING_PAYMENT // Waiting for advance payment
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum SessionStatus {
  PENDING
  EVALUATED
  COMPLETED
}

enum PaymentMethod {
  CASH // Efectivo / Dinheiro
  QR // QR Bolivia / PIX Brasil (pago instantáneo)
  CARD // Tarjeta POS / Cartão
  TRANSFER // Transferencia / TED-DOC
}

// Tipos de pago a staff (más específicos)
enum StaffPaymentType {
  // Movimientos positivos (ingresos para el empleado)
  SALARY // Sueldo del período
  COMMISSION // Comisión
  BONUS // Bono / Horas extra
  BENEFIT // Aguinaldo / Viáticos / Beneficios
  SETTLEMENT // Liquidación
  ADVANCE // Adelanto (aumenta deuda, pero es ingreso)

  // Movimientos negativos (descuentos para el empleado)
  DEDUCTION // Descuento (faltas, tardanzas, etc.)
  ADVANCE_RETURN // Devolución de adelanto (reduce deuda)
}

// Estado del movimiento/pago
enum PaymentStatus {
  PENDING // Movimiento registrado, pendiente de pago
  PAID // Pago realizado / Movimiento incluido en pago
}

// Frecuencia de pago del empleado
enum PayFrequency {
  DAILY // Diario
  WEEKLY // Semanal
  BIWEEKLY // Quincenal
  MONTHLY // Mensual
}

// Categorías de gastos administrativos
enum ExpenseCategory {
  RENT // Alquiler
  UTILITIES // Servicios (agua, luz, internet)
  SUPPLIES // Insumos
  MAINTENANCE // Mantenimiento / Reparaciones
  MARKETING // Marketing / Publicidad
  TAXES // Impuestos / Contabilidad
  INSURANCE // Seguros
  EQUIPMENT // Equipos / Mobiliario
  OTHER // Otros
}

enum MovementType {
  PURCHASE
  SALE
  USAGE
  ADJUSTMENT
}

// Tipo de servicio (para paquetes)
enum ServiceType {
  BABY // Servicio para bebés (hidroterapia, vacunas, etc.)
  PARENT // Servicio para padres (masaje prenatal, postparto, etc.)
}

// ============================================================
// ENUMS PARA EVENTOS GRUPALES
// ============================================================

enum ParentStatus {
  LEAD // Padre potencial (embarazada sin bebé)
  ACTIVE // Cliente activo
  INACTIVE // Cliente inactivo
}

enum EventType {
  BABIES // Eventos para bebés (Hora de Juego, Babython)
  PARENTS // Eventos para padres/leads (Talleres prenatales)
}

enum EventStatus {
  DRAFT // Borrador, no visible públicamente
  PUBLISHED // Publicado, abierto para inscripciones
  IN_PROGRESS // En curso
  COMPLETED // Finalizado
  CANCELLED // Cancelado
}

enum ParticipantStatus {
  REGISTERED // Registrado/inscrito
  CONFIRMED // Confirmado (pagó o cortesía)
  CANCELLED // Canceló participación
  NO_SHOW // No asistió
}

enum DiscountType {
  COURTESY // Gratis (100% descuento)
  FIXED // Descuento fijo en monto
}

enum MuscleTone {
  LOW
  NORMAL
  TENSE
}

// ============================================================
// ENUMS PARA BABY CARD (Sistema de Fidelización)
// ============================================================

enum RewardType {
  SERVICE // Un paquete/servicio gratis
  PRODUCT // Un producto físico gratis
  EVENT // Acceso gratis a evento
  CUSTOM // Premio personalizado (solo texto/diploma/etc.)
}

enum BabyCardStatus {
  ACTIVE // En progreso
  COMPLETED // Completó todas las sesiones
  REPLACED // Fue reemplazada por otra card
  CANCELLED // Cancelada/reembolsada
}

// ============================================================
// ENUMS PARA TRANSACCIONES (Nuevo sistema centralizado)
// ============================================================

enum TransactionType {
  INCOME // Ingreso (ventas, pagos recibidos)
  EXPENSE // Egreso (pagos a staff, gastos)
}

enum TransactionCategory {
  // Ingresos de servicios
  SESSION // Checkout de sesión completo
  PACKAGE_SALE // Venta de paquete (contado o primera cuota)
  PACKAGE_INSTALLMENT // Cuota de paquete

  // Ingresos de productos
  SESSION_PRODUCTS // Productos vendidos en sesión
  EVENT_PRODUCTS // Productos vendidos en evento

  // Otros ingresos
  BABY_CARD // Venta de Baby Card
  EVENT_REGISTRATION // Inscripción a evento
  APPOINTMENT_ADVANCE // Anticipo de cita

  // Egresos
  STAFF_PAYMENT // Pago a empleados
  ADMIN_EXPENSE // Gasto administrativo
}

enum ItemType {
  PACKAGE // Paquete/servicio
  PRODUCT // Producto de inventario
  EVENT_TICKET // Entrada a evento
  BABY_CARD // Baby Card
  INSTALLMENT // Cuota de paquete
  ADVANCE // Anticipo
  DISCOUNT // Descuento aplicado (línea negativa)
  OTHER // Otro concepto
}

enum Mood {
  CALM
  IRRITABLE
}

// Para Notification (notificaciones en tiempo real al staff)
enum StaffNotificationType {
  NEW_APPOINTMENT // Cita agendada desde portal
  CANCELLED_APPOINTMENT // Cita cancelada desde portal
  RESCHEDULED_APPOINTMENT // Cita reagendada desde portal
  CASH_REGISTER_DIFFERENCE // Arqueo cerrado con diferencia
  REENGAGEMENT_ALERT // Cliente inactivo requiere seguimiento
  LEAD_DUE_DATE // Lead que puede haber dado a luz
}

// Para Arqueo de Caja
enum CashRegisterStatus {
  OPEN // Caja abierta
  CLOSED // Cerrada, pendiente revisión (si diferencia ≠ 0)
  APPROVED // Aprobada (diferencia = 0 o admin aprobó)
  FORCE_CLOSED // Cerrada forzadamente por admin
}

enum CashExpenseCategory {
  SUPPLIES // Insumos
  FOOD // Comida/Refrigerios
  TRANSPORT // Transporte (taxi, delivery)
  BANK_DEPOSIT // Depósito a banco / Entrega a dueño
  OTHER // Otro (descripción obligatoria)
}

// ============================================================
// ENUMS PARA FASE 11 - CRON JOBS Y MENSAJERÍA
// ============================================================

enum TemplateCategory {
  APPOINTMENT // Recordatorios de citas
  MESVERSARY // Mesversarios
  REENGAGEMENT // Re-engagement de clientes inactivos
  LEAD // Mensajes para leads
  ADMIN // Resumen diario, alertas admin
}

enum PendingMessageCategory {
  APPOINTMENT_REMINDER // Recordatorio de cita
  PAYMENT_REMINDER // Recordatorio de pago
  MESVERSARY // Mesversario
  REENGAGEMENT // Re-engagement
}

enum RecipientType {
  PARENT // Padre/Madre
  BABY // Referencia a bebé (mensaje va al padre)
  LEAD // Lead sin bebé
}

enum PendingMessageStatus {
  PENDING // Pendiente de enviar
  SENT // Enviado por staff
  SKIPPED // Omitido con razón
  EXPIRED // Expirado (>3 días)
}

enum EmailStatus {
  SENT // Enviado
  DELIVERED // Entregado
  OPENED // Abierto
  BOUNCED // Rebotado
  COMPLAINED // Marcado como spam
}

// Para Activity (registro de actividad/auditoría)
enum ActivityType {
  // Sesiones
  SESSION_COMPLETED
  DISCOUNT_APPLIED

  // Citas
  APPOINTMENT_CREATED
  APPOINTMENT_CREATED_PORTAL
  APPOINTMENT_CANCELLED
  APPOINTMENT_CANCELLED_PORTAL
  APPOINTMENT_RESCHEDULED
  APPOINTMENT_RESCHEDULED_PORTAL

  // Baby Card
  BABY_CARD_SOLD
  BABY_CARD_REWARD_DELIVERED

  // Pagos
  INSTALLMENT_PAID

  // Caja (Fase 10)
  CASH_REGISTER_OPENED
  CASH_REGISTER_CLOSED
  CASH_REGISTER_EXPENSE_ADDED
  CASH_REGISTER_FORCE_CLOSED
  CASH_REGISTER_REVIEWED

  // Eventos
  EVENT_REGISTRATION

  // Bebés y Clientes
  BABY_CREATED
  PACKAGE_ASSIGNED
  CLIENT_UPDATED

  // Evaluaciones (Terapeutas)
  EVALUATION_SAVED

  // Staff Payments y Gastos (Fase 7)
  STAFF_PAYMENT_REGISTERED
  EXPENSE_REGISTERED

  // Anulaciones (Reversal Entry)
  TRANSACTION_VOIDED
}

// ============================================================
// USUARIOS DEL SISTEMA (Staff)
// ============================================================

model User {
  id                 String   @id @default(cuid())
  username           String   @unique
  email              String?
  passwordHash       String
  name               String
  role               UserRole
  phone              String?
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true) // Forzar cambio en primer login

  // Para control de sueldos
  baseSalary   Decimal?     @db.Decimal(10, 2)
  payFrequency PayFrequency @default(MONTHLY)

  // Campos para resumen diario (Fase 11)
  receiveDailySummary Boolean @default(false) // ¿Recibe resumen diario?
  dailySummaryEmail   String? // Email para resumen (puede ser diferente)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  sessionsAsTherapist      Session[]
  pendingMessagesSent      PendingMessage[]      @relation("PendingMessageSentBy")
  appointmentsAssigned     Appointment[]
  registrationLinks        RegistrationLink[]
  babyNotes                BabyNote[]
  staffPaymentsReceived    StaffPayment[]        @relation("StaffPaymentsReceived")
  staffPaymentsCreated     StaffPayment[]        @relation("StaffPaymentsCreated")
  staffPaymentsDeleted     StaffPayment[]        @relation("StaffPaymentsDeleted")
  advanceBalance           StaffAdvanceBalance?
  createdEvents            Event[]
  registeredParticipants   EventParticipant[]
  babyCardPurchasesCreated BabyCardPurchase[]    @relation("BabyCardPurchasesCreated")
  babyCardRewardsApplied   BabyCardRewardUsage[] @relation("BabyCardRewardsApplied")
  transactionsCreated      Transaction[]         @relation("TransactionsCreated")
  transactionsVoided       Transaction[]         @relation("TransactionsVoided")
  notificationsRead        Notification[]        @relation("NotificationReadBy")
  activitiesPerformed      Activity[]            @relation("ActivitiesPerformed")
  expensesCreated          Expense[]             @relation("ExpensesCreated")
  expensesDeleted          Expense[]             @relation("ExpensesDeleted")

  // Cash Register relations (Fase 10)
  cashRegistersOpened      CashRegister[]        @relation("CashRegisterOpenedBy")
  cashRegistersReviewed    CashRegister[]        @relation("CashRegisterReviewedBy")
  cashRegistersForceClosed CashRegister[]        @relation("CashRegisterForcedBy")
  cashRegisterExpenses     CashRegisterExpense[] @relation("CashRegisterExpenseCreatedBy")

  @@map("users")
}

// ============================================================
// PADRES / TUTORES
// ============================================================

model Parent {
  id String @id @default(cuid())

  // Identificador único (opcional para padre/tutor secundario)
  phone String? @unique

  name      String
  email     String?
  birthDate DateTime?

  // Acceso al portal
  accessCode String @unique // BSB-XXXXX

  // Sistema de penalización
  noShowCount        Int       @default(0)
  requiresPrepayment Boolean   @default(false)
  lastNoShowDate     DateTime?

  // Status y campos LEAD (para talleres prenatales)
  status         ParentStatus @default(ACTIVE)
  pregnancyWeeks Int? // Semanas de embarazo (para LEADs)
  leadSource     String? // Fuente del lead (Instagram, Referido, etc.)
  leadNotes      String? // Notas sobre el lead
  convertedAt    DateTime? // Fecha en que pasó de LEAD a ACTIVE

  // Campos para mensajería automatizada (Fase 11)
  emailBounceCount   Int       @default(0) // Contador de rebotes de email
  lastSessionAt      DateTime? // Última sesión completada
  lastReengagementAt DateTime? // Último mensaje de re-engagement
  lastMessageSentAt  DateTime? // Control de frecuencia de mensajes
  marketingOptIn     Boolean   @default(true) // Opt-out desde portal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  babies              BabyParent[]
  emailLogs           EmailLog[]
  eventParticipations EventParticipant[]

  // Servicios para el padre (masaje prenatal, postparto, etc.)
  appointments     Appointment[]
  packagePurchases PackagePurchase[]

  // Cron job indexes (Fase 11)
  @@index([lastSessionAt]) // Reengagement of inactive clients
  @@index([noShowCount, requiresPrepayment]) // Auto-activate prepayment
  @@index([status]) // Filter by LEAD/ACTIVE/INACTIVE
  @@index([status, createdAt])
  @@index([convertedAt])
  @@map("parents")
}

// ============================================================
// BEBÉS
// ============================================================

model Baby {
  id String @id @default(cuid())

  name      String
  birthDate DateTime
  gender    Gender

  // Datos de nacimiento
  birthWeeks  Int?
  birthWeight Decimal?   @db.Decimal(4, 2)
  birthType   BirthType?

  // Datos médicos
  birthDifficulty          Boolean @default(false)
  birthDifficultyDesc      String?
  pregnancyIssues          Boolean @default(false)
  pregnancyIssuesDesc      String?
  priorStimulation         Boolean @default(false)
  priorStimulationType     String?
  developmentDiagnosis     Boolean @default(false)
  developmentDiagnosisDesc String?
  diagnosedIllness         Boolean @default(false)
  diagnosedIllnessDesc     String?
  recentMedication         Boolean @default(false)
  recentMedicationDesc     String?
  allergies                String?
  specialObservations      String?

  // Autorizaciones
  socialMediaConsent Boolean @default(false)
  instagramHandle    String?

  // Marketing
  referralSource String?

  // Campos para mensajería automatizada (Fase 11)
  lastMesversaryNotifiedMonth Int? // Mes del último mesversario notificado

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parents             BabyParent[]
  packagePurchases    PackagePurchase[]
  appointments        Appointment[]
  sessions            Session[]
  notes               BabyNote[]
  eventParticipations EventParticipant[]
  babyCardPurchases   BabyCardPurchase[]

  // Cron job indexes (Fase 11)
  @@index([birthDate, isActive]) // Mesversaries and deactivation of old babies
  @@index([lastMesversaryNotifiedMonth]) // Mesversary tracking
  @@index([isActive, createdAt])
  @@map("babies")
}

// ============================================================
// RELACIÓN BEBÉ - PADRE (N:M)
// ============================================================

model BabyParent {
  id           String  @id @default(cuid())
  babyId       String
  baby         Baby    @relation(fields: [babyId], references: [id], onDelete: Restrict)
  parentId     String
  parent       Parent  @relation(fields: [parentId], references: [id], onDelete: Restrict)
  relationship String  @default("MOTHER")
  isPrimary    Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([babyId, parentId])
  // Performance indexes
  @@index([babyId, isPrimary])
  @@index([parentId, isPrimary])
  @@map("baby_parents")
}

// ============================================================
// NOTAS INTERNAS DEL BEBÉ
// ============================================================

model BabyNote {
  id     String @id @default(cuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id])
  note   String

  createdAt DateTime @default(now())

  @@index([babyId])
  @@index([userId])
  @@map("baby_notes")
}

// ============================================================
// LINK REGISTRO TEMPORAL
// ============================================================

model RegistrationLink {
  id    String @id @default(cuid())
  token String @unique

  // Datos pre-llenados por recepción (solo teléfono requerido)
  parentName  String?
  parentPhone String

  expiresAt DateTime // 5 días desde creación
  isUsed    Boolean   @default(false)
  usedAt    DateTime?

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Referencias al padre y bebé creados (se llenan al completar)
  babyId   String?
  parentId String?

  createdAt DateTime @default(now())

  @@map("registration_links")
}

// ============================================================
// CATEGORÍAS (para paquetes y productos)
// ============================================================

enum CategoryType {
  PACKAGE
  PRODUCT
}

model Category {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        CategoryType // PACKAGE o PRODUCT
  color       String? // Color para UI (ej: "teal", "amber")
  sortOrder   Int          @default(0)
  isActive    Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packages Package[]
  products Product[]

  @@unique([name, type])
  @@map("categories")
}

// ============================================================
// CATÁLOGO DE PAQUETES
// ============================================================

model Package {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Tipo de servicio: para bebés o para padres
  serviceType ServiceType @default(BABY)

  // Relación con categoría
  categoryId   String?
  categoryRef  Category? @relation(fields: [categoryId], references: [id])
  sessionCount Int
  basePrice    Decimal   @db.Decimal(10, 2)

  // Duración y pago anticipado
  duration               Int      @default(60) // Duración en minutos
  requiresAdvancePayment Boolean  @default(false) // Requiere pago anticipado
  advancePaymentAmount   Decimal? @db.Decimal(10, 2) // Monto del anticipo

  // Configuración de cuotas (definidas por el admin)
  allowInstallments         Boolean  @default(false) // ¿Permite pago en cuotas?
  installmentsCount         Int? // Cantidad de cuotas: 3
  installmentsTotalPrice    Decimal? @db.Decimal(10, 2) // Precio total en cuotas (puede ser mayor)
  installmentsPayOnSessions String? // En qué sesiones pagar: "1,3,5"

  isActive  Boolean @default(true)
  isPublic  Boolean @default(true) // false = solo para premios Baby Card y uso interno
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases             PackagePurchase[]
  appointments          Appointment[] // Citas que tienen este paquete pre-seleccionado
  systemSettings        SystemSettings[]       @relation("DefaultPackage")
  babyCardSpecialPrices BabyCardSpecialPrice[]
  babyCardRewards       BabyCardReward[]

  @@index([categoryId])
  @@map("packages")
}

// ============================================================
// COMPRA DE PAQUETE
// ============================================================

model PackagePurchase {
  id String @id @default(cuid())

  // Cliente: bebé O padre (según serviceType del paquete)
  babyId   String?
  baby     Baby?   @relation(fields: [babyId], references: [id])
  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id])

  packageId String
  package   Package @relation(fields: [packageId], references: [id])

  basePrice      Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  discountReason String?
  finalPrice     Decimal @db.Decimal(10, 2)

  totalSessions     Int
  usedSessions      Int @default(0)
  remainingSessions Int

  // Patrón de visitas
  visitPattern  String? // FIXED_DAY, FREQUENCY, IRREGULAR
  fixedDay      Int? // 0-6 si FIXED_DAY
  frequencyDays Int? // Cada X días si FREQUENCY

  // Financiamiento - Pago en cuotas
  paymentPlan               String   @default("SINGLE") // SINGLE | INSTALLMENTS
  installments              Int      @default(1) // Número de cuotas (1 = pago único)
  totalPrice                Decimal? @db.Decimal(10, 2) // Precio total a pagar (único o cuotas) - null usa finalPrice
  installmentAmount         Decimal? @db.Decimal(10, 2) // Monto por cuota
  paidAmount                Decimal  @default(0) @db.Decimal(10, 2) // Total pagado hasta ahora
  installmentsPayOnSessions String? // Copiado del paquete: "1,3,5"

  // Preferencia de horario del padre (para auto-agendado masivo)
  // Formato JSON: [{"dayOfWeek": 1, "time": "09:00"}, {"dayOfWeek": 4, "time": "15:00"}]
  schedulePreferences String? @db.Text

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions     Session[]
  appointments Appointment[]
  // installmentPayments: Ahora se usan Transactions con referenceType="PackagePurchase"

  // Performance indexes
  @@index([babyId, isActive])
  @@index([parentId, isActive])
  @@index([packageId])
  @@index([isActive, paymentPlan])
  @@index([babyId, remainingSessions])
  @@index([parentId, remainingSessions])
  @@map("package_purchases")
}

// ============================================================
// CITAS (Agendamiento)
// ============================================================

model Appointment {
  id String @id @default(cuid())

  // Cliente: bebé O padre (según serviceType del paquete)
  babyId   String?
  baby     Baby?   @relation(fields: [babyId], references: [id])
  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id])

  // Paquete seleccionado (provisional hasta checkout)
  // Si el bebé tiene paquete comprado -> usa packagePurchaseId
  // Si selecciona del catálogo -> usa selectedPackageId
  selectedPackageId String? // Paquete del catálogo (provisional)
  selectedPackage   Package?         @relation(fields: [selectedPackageId], references: [id])
  packagePurchaseId String? // Paquete comprado existente
  packagePurchase   PackagePurchase? @relation(fields: [packagePurchaseId], references: [id])

  // Fecha sin componente de hora (evita problemas de timezone)
  date      DateTime @db.Date
  // Horas como strings simples "09:00", "09:30", "14:30" (sin timezone)
  startTime String // HH:mm format
  endTime   String // HH:mm format

  status AppointmentStatus @default(SCHEDULED)

  // Terapeuta asignado (se asigna al iniciar la cita)
  therapistId String?
  therapist   User?   @relation(fields: [therapistId], references: [id])

  // Indica si el terapeuta registró la evaluación (independiente del status)
  isEvaluated Boolean @default(false)

  // Campos para recordatorios automatizados (Fase 11)
  reminder24hSent     Boolean   @default(false)
  reminder24hSentAt   DateTime?
  reminderDaySent     Boolean   @default(false) // Recordatorio del día (WhatsApp)
  paymentReminderSent Boolean   @default(false) // Recordatorio de pago 48h

  notes        String?
  cancelReason String?

  // For advance payment tracking
  isPendingPayment Boolean @default(false)

  // Pending schedule preferences (from portal, before checkout)
  // Transferred to PackagePurchase.schedulePreferences when completed
  pendingSchedulePreferences String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session Session?
  history AppointmentHistory[]
  // payments: Ahora se usan Transactions con referenceType="Appointment"

  // Performance indexes
  @@index([date, status])
  @@index([babyId, status])
  @@index([therapistId, date, status])
  @@index([parentId, date, status])
  @@index([status])
  @@index([isPendingPayment])
  // Cron job indexes (Fase 11)
  @@index([date, status, reminder24hSent]) // 24h email reminders
  @@index([date, status, reminderDaySent]) // Same-day WhatsApp reminders
  @@index([date, status, paymentReminderSent]) // Payment reminders
  @@index([packagePurchaseId])
  @@index([status, isEvaluated])
  @@map("appointments")
}

// ============================================================
// HISTORIAL DE CAMBIOS DE CITA
// ============================================================

model AppointmentHistory {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  action        String // CREATED, RESCHEDULED, CANCELLED, COMPLETED, NO_SHOW
  performedBy   String // user_id o parent_id
  performerType String // USER o PARENT
  performerName String

  oldValue Json?
  newValue Json?
  reason   String?

  createdAt DateTime @default(now())

  @@index([appointmentId])
  @@map("appointment_history")
}

// ============================================================
// PAGOS DE CITAS - MODELO ELIMINADO
// ============================================================
// Los anticipos de citas ahora se registran como Transaction con:
//   category = APPOINTMENT_ADVANCE
//   referenceType = "Appointment"
//   referenceId = appointmentId

// ============================================================
// SESIONES (Ejecución)
// ============================================================

model Session {
  id                String           @id @default(cuid())
  appointmentId     String           @unique
  appointment       Appointment      @relation(fields: [appointmentId], references: [id])
  babyId            String? // Optional: null for parent-only appointments
  baby              Baby?            @relation(fields: [babyId], references: [id])
  therapistId       String
  therapist         User             @relation(fields: [therapistId], references: [id])
  packagePurchaseId String?
  packagePurchase   PackagePurchase? @relation(fields: [packagePurchaseId], references: [id])

  sessionNumber Int
  status        SessionStatus @default(PENDING)

  startedAt   DateTime?
  evaluatedAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  evaluation         Evaluation?
  products           SessionProduct[]
  babyCardSessionLog BabyCardSessionLog?

  // Performance indexes
  @@index([therapistId, status])
  @@index([babyId, status])
  @@index([packagePurchaseId, status])
  @@index([status])
  @@index([completedAt])
  @@map("sessions")
}

// ============================================================
// EVALUACIÓN DE SESIÓN
// ============================================================

model Evaluation {
  id        String  @id @default(cuid())
  sessionId String  @unique
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  babyAgeMonths Int
  babyWeight    Decimal? @db.Decimal(4, 2)

  // Actividades realizadas en la sesión
  hydrotherapy       Boolean @default(false)
  massage            Boolean @default(false)
  motorStimulation   Boolean @default(false)
  sensoryStimulation Boolean @default(false)
  relaxation         Boolean @default(false)
  otherActivities    String? // Otras actividades (texto libre)

  // Evaluación sensorial
  visualTracking   Boolean?
  eyeContact       Boolean?
  auditoryResponse Boolean?

  // Desarrollo muscular
  muscleTone      MuscleTone?
  cervicalControl Boolean?
  headUp          Boolean?

  // Hitos
  sits   Boolean?
  crawls Boolean?
  walks  Boolean?

  // Estado
  mood Mood?

  // Comentarios
  internalNotes String? // Solo visible para staff
  externalNotes String? // Visible para padres

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("evaluations")
}

// ============================================================
// PRODUCTOS (Inventario)
// ============================================================

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Relación con categoría
  categoryId  String?
  categoryRef Category? @relation(fields: [categoryId], references: [id])

  costPrice    Decimal @db.Decimal(10, 2)
  salePrice    Decimal @db.Decimal(10, 2)
  currentStock Int     @default(0)
  minStock     Int     @default(5)
  isActive     Boolean @default(true)

  // Valor por defecto cuando se usa en sesiones
  isChargeableByDefault Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movements       InventoryMovement[]
  sessionUsages   SessionProduct[]
  eventUsages     EventProductUsage[]
  babyCardRewards BabyCardReward[]

  @@index([categoryId])
  @@map("products")
}

// ============================================================
// MOVIMIENTOS DE INVENTARIO
// ============================================================

model InventoryMovement {
  id          String       @id @default(cuid())
  productId   String
  product     Product      @relation(fields: [productId], references: [id])
  type        MovementType
  quantity    Int
  unitPrice   Decimal      @db.Decimal(10, 2)
  totalAmount Decimal      @db.Decimal(10, 2)
  notes       String?
  stockAfter  Int

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
  @@index([productId, createdAt])
  @@map("inventory_movements")
}

// ============================================================
// PRODUCTOS USADOS EN SESIÓN
// ============================================================

model SessionProduct {
  id           String  @id @default(cuid())
  sessionId    String
  session      Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  productId    String
  product      Product @relation(fields: [productId], references: [id])
  quantity     Int     @default(1)
  unitPrice    Decimal @db.Decimal(10, 2)
  isChargeable Boolean @default(false)

  // Campos para descuentos individuales
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  discountReason String?

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([sessionId])
  @@map("session_products")
}

// ============================================================
// PAGOS DE CUOTAS - MODELO ELIMINADO
// ============================================================
// Las cuotas de paquetes ahora se registran como Transaction con:
//   category = PACKAGE_INSTALLMENT
//   referenceType = "PackagePurchase"
//   referenceId = packagePurchaseId
//   items: [{ itemType: INSTALLMENT, description: "Cuota 2 de 4", ... }]

// ============================================================
// PAGOS AL PERSONAL
// ============================================================

model StaffPayment {
  id String @id @default(cuid())

  // Empleado que recibe el pago
  staffId String
  staff   User   @relation("StaffPaymentsReceived", fields: [staffId], references: [id])

  // Tipo y estado
  type   StaffPaymentType
  status PaymentStatus    @default(PENDING)

  // Montos
  grossAmount Decimal @db.Decimal(10, 2) // Monto bruto (puede ser negativo para deducciones)
  netAmount   Decimal @db.Decimal(10, 2) // Monto neto (después de descuentos de adelanto)

  // Descuento de adelanto (solo aplica para SALARY)
  advanceDeducted Decimal? @db.Decimal(10, 2) // Monto descontado de adelanto

  // Descripción
  description String

  // Período de pago (fechas flexibles para cualquier frecuencia)
  periodStart  DateTime? // Inicio del período (nullable para migración)
  periodEnd    DateTime? // Fin del período (nullable para migración)
  movementDate DateTime? // Fecha específica del movimiento (ej: día de la falta)

  // Campos legacy (para compatibilidad)
  periodMonth Int? // Mes del período (1-12)
  periodYear  Int? // Año del período

  // Fecha del pago real (null si es movimiento pendiente)
  paidAt DateTime?

  // Referencia al pago de salario que incluyó este movimiento (para trazabilidad)
  includedInSalaryId String?
  includedInSalary   StaffPayment?  @relation("MovementsIncludedInSalary", fields: [includedInSalaryId], references: [id])
  includedMovements  StaffPayment[] @relation("MovementsIncludedInSalary")

  // Auditoría
  createdById String
  createdBy   User     @relation("StaffPaymentsCreated", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  // Soft delete
  deletedAt   DateTime?
  deletedById String?
  deletedBy   User?     @relation("StaffPaymentsDeleted", fields: [deletedById], references: [id])

  @@index([staffId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([type])
  @@index([deletedAt])
  @@index([paidAt])
  @@index([includedInSalaryId])
  @@index([staffId, deletedAt, type])
  @@map("staff_payments")
}

// ============================================================
// CONTROL DE ADELANTOS PENDIENTES
// ============================================================

model StaffAdvanceBalance {
  id String @id @default(cuid())

  staffId String @unique
  staff   User   @relation(fields: [staffId], references: [id])

  currentBalance Decimal @default(0) @db.Decimal(10, 2) // Saldo pendiente de adelanto

  updatedAt DateTime @updatedAt

  @@map("staff_advance_balances")
}

// ============================================================
// GASTOS ADMINISTRATIVOS
// ============================================================

model Expense {
  id String @id @default(cuid())

  // Categoría y descripción
  category    ExpenseCategory
  description String

  // Monto
  amount Decimal @db.Decimal(10, 2)

  // Referencia/comprobante
  reference String? // Número de factura, etc.

  // Fecha del gasto
  expenseDate DateTime @default(now()) @db.Date

  // Auditoría
  createdById String
  createdBy   User     @relation("ExpensesCreated", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  // Soft delete
  deletedAt   DateTime?
  deletedById String?
  deletedBy   User?     @relation("ExpensesDeleted", fields: [deletedById], references: [id])

  @@index([expenseDate])
  @@index([category])
  @@index([deletedAt])
  @@map("expenses")
}

// ============================================================
// NOTIFICACIONES EN TIEMPO REAL (Staff)
// ============================================================

model Notification {
  id String @id @default(cuid())

  // Tipo y contenido
  type    StaffNotificationType
  title   String
  message String

  // Referencia para navegación
  entityType String? // "appointment"
  entityId   String? // ID de la cita

  // Datos adicionales para navegación
  metadata Json? // { date: "2026-01-28", isPendingPayment: true }

  // Estado de lectura (compartido entre staff)
  isRead   Boolean   @default(false)
  readAt   DateTime?
  readById String?
  readBy   User?     @relation("NotificationReadBy", fields: [readById], references: [id])

  // Audiencia
  forRole UserRole @default(RECEPTION)

  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime // createdAt + 7 días

  @@index([isRead, forRole])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================
// HORARIOS DE ATENCIÓN
// ============================================================

model BusinessHours {
  id             String  @id @default(cuid())
  dayOfWeek      Int // 0=Dom, 1=Lun, ..., 6=Sab
  morningOpen    String? // HH:mm format
  morningClose   String? // HH:mm format
  afternoonOpen  String? // HH:mm format
  afternoonClose String? // HH:mm format
  isOpen         Boolean @default(true)

  @@unique([dayOfWeek])
  @@map("business_hours")
}

// ============================================================
// DÍAS CERRADOS
// ============================================================

model ClosedDate {
  id     String   @id @default(cuid())
  date   DateTime @db.Date
  reason String?

  @@unique([date])
  @@map("closed_dates")
}

// ============================================================
// CONFIGURACIÓN GLOBAL DEL SISTEMA
// ============================================================

model SystemSettings {
  id String @id @default("default")

  // Paquete por defecto para citas sin paquete
  defaultPackageId String?
  defaultPackage   Package? @relation("DefaultPackage", fields: [defaultPackageId], references: [id])

  // Configuración de pagos (para Fase 3.2)
  paymentQrImage      String? @db.Text // Base64 encoded QR image
  paymentQrImageUrl   String? // URL de la imagen del QR de pago (legacy)
  whatsappNumber      String? // Número de WhatsApp para comprobantes
  whatsappCountryCode String? @default("+591") // Country code for WhatsApp
  whatsappMessage     String? @default("Hola, adjunto mi comprobante de pago para la cita del {fecha} a las {hora}. Bebé: {bebe}")

  // Redes sociales y contacto
  instagramHandle String? // Handle de Instagram (sin @)
  businessAddress String? // Dirección física del negocio

  // Configuración de notificaciones
  notificationPollingInterval Int @default(5) // Intervalo de polling en minutos (1-30)
  notificationExpirationDays  Int @default(7) // Días hasta que expira una notificación (1-30)

  // Configuración de slots de citas (MP-001)
  maxSlotsStaff  Int @default(5) // Límite de citas por slot para staff (1-10)
  maxSlotsPortal Int @default(2) // Límite de citas por slot para portal padres (1-5)

  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ============================================================
// EVENTOS GRUPALES
// ============================================================

model Event {
  id          String    @id @default(cuid())
  name        String
  description String?
  type        EventType // BABIES o PARENTS

  // Fecha y horario
  date      DateTime @db.Date
  startTime String // HH:mm format
  endTime   String // HH:mm format

  // Capacidad y bloqueo
  maxParticipants   Int @default(10)
  blockedTherapists Int @default(0) // 0-4: cuántos terapeutas se bloquean

  // Rango de edad (solo para eventos tipo BABIES)
  minAgeMonths Int? // Edad mínima en meses
  maxAgeMonths Int? // Edad máxima en meses

  // Precio y descuentos
  basePrice Decimal @db.Decimal(10, 2)

  status EventStatus @default(DRAFT)

  // Notas
  internalNotes String? // Solo visible para staff
  externalNotes String? // Visible para padres (descripción pública)

  // Auditoría
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants  EventParticipant[]
  productUsages EventProductUsage[]

  @@index([date, status])
  @@map("events")
}

// ============================================================
// PARTICIPANTES DE EVENTOS
// ============================================================

model EventParticipant {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Participante: bebé O padre (mutuamente excluyentes según tipo evento)
  babyId   String?
  baby     Baby?   @relation(fields: [babyId], references: [id])
  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id])

  status ParticipantStatus @default(REGISTERED)

  // Descuentos individuales por participante
  discountType   DiscountType? // COURTESY o FIXED
  discountAmount Decimal?      @db.Decimal(10, 2) // Monto si es FIXED
  discountReason String? // Razón del descuento

  // Pago
  amountDue        Decimal        @db.Decimal(10, 2) // Monto a pagar (precio - descuento)
  amountPaid       Decimal        @default(0) @db.Decimal(10, 2)
  paymentMethod    PaymentMethod?
  paymentReference String?
  paidAt           DateTime?

  // Asistencia
  attended   Boolean? // null = no marcado, true = asistió, false = no asistió
  attendedAt DateTime?

  // Notas
  notes String?

  // Lead data (for PARENTS events - pregnant attendees without Parent record)
  name            String? // Name if not linked to Parent
  phone           String? // Phone if not linked to Parent
  email           String? // Email if not linked to Parent
  expectedDueDate DateTime? // Expected due date for pregnant leads
  followUpAt      DateTime? // Last follow-up date for lead tracking

  // Auditoría
  registeredById String
  registeredBy   User   @relation(fields: [registeredById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, babyId])
  @@unique([eventId, parentId])
  // Performance indexes
  @@index([eventId, status])
  @@index([babyId, status])
  @@index([parentId, status])
  @@index([expectedDueDate]) // For lead alerts cron job
  @@map("event_participants")
}

// ============================================================
// PRODUCTOS USADOS EN EVENTOS
// ============================================================

model EventProductUsage {
  id        String  @id @default(cuid())
  eventId   String
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int     @default(1)
  unitPrice Decimal @db.Decimal(10, 2)
  notes     String?

  // Para distinguir uso interno vs venta
  isChargeable Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([productId])
  @@map("event_product_usages")
}

// ============================================================
// BABY CARD - SISTEMA DE FIDELIZACIÓN
// ============================================================

// Plantilla/Catálogo de Baby Cards
model BabyCard {
  id          String  @id @default(cuid())
  name        String // "Baby Spa Card Premium"
  description String? @db.Text

  // Precio y configuración
  price                Decimal @db.Decimal(10, 2) // Precio de la tarjeta
  totalSessions        Int // Total de sesiones para completar
  firstSessionDiscount Decimal @default(0) @db.Decimal(10, 2) // Monto de descuento en primera sesión

  // Estado
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  specialPrices BabyCardSpecialPrice[]
  rewards       BabyCardReward[]
  purchases     BabyCardPurchase[]

  @@map("baby_cards")
}

// Precios especiales por paquete/servicio
model BabyCardSpecialPrice {
  id           String  @id @default(cuid())
  babyCardId   String
  packageId    String // Paquete al que aplica (ej: Sesión Individual)
  specialPrice Decimal @db.Decimal(10, 2) // Precio con Baby Card

  babyCard BabyCard @relation(fields: [babyCardId], references: [id], onDelete: Cascade)
  package  Package  @relation(fields: [packageId], references: [id])

  @@unique([babyCardId, packageId])
  @@map("baby_card_special_prices")
}

// Premios configurados en cada Baby Card
model BabyCardReward {
  id            String @id @default(cuid())
  babyCardId    String
  sessionNumber Int // En qué sesión se desbloquea (3, 7, 10, etc.)

  // Tipo de premio
  rewardType RewardType // SERVICE | PRODUCT | EVENT | CUSTOM

  // Referencias según tipo
  packageId String? // Si rewardType = SERVICE
  productId String? // Si rewardType = PRODUCT

  // Para premios personalizados (CUSTOM)
  customName        String? // "Diploma de Graduación"
  customDescription String? @db.Text

  // Display
  displayName String // "Sesión de Fotos Gratis"
  displayIcon String? // Emoji o nombre de icono lucide

  createdAt DateTime @default(now())

  babyCard BabyCard @relation(fields: [babyCardId], references: [id], onDelete: Cascade)
  package  Package? @relation(fields: [packageId], references: [id])
  product  Product? @relation(fields: [productId], references: [id])

  usages BabyCardRewardUsage[]

  @@unique([babyCardId, sessionNumber])
  @@map("baby_card_rewards")
}

// Compra/Asignación de Baby Card a un bebé
model BabyCardPurchase {
  id         String @id @default(cuid())
  babyCardId String
  babyId     String

  // Pago
  pricePaid        Decimal        @db.Decimal(10, 2)
  paymentMethod    PaymentMethod?
  paymentReference String?

  // Progreso
  completedSessions Int @default(0)

  // Estado
  status BabyCardStatus @default(ACTIVE)

  // Descuento primera sesión
  firstSessionDiscountUsed      Boolean   @default(false)
  firstSessionDiscountAmount    Decimal?  @db.Decimal(10, 2) // Monto realmente descontado
  firstSessionDiscountAppliedTo String? // ID de la cita/paquete donde se aplicó
  firstSessionDiscountDate      DateTime?

  // Fechas
  purchaseDate         DateTime  @default(now())
  completedDate        DateTime? // Cuando completó todas las sesiones
  replacedDate         DateTime? // Si fue reemplazada por otra card
  replacedByPurchaseId String? // ID de la card que la reemplazó

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Relaciones
  babyCard  BabyCard @relation(fields: [babyCardId], references: [id])
  baby      Baby     @relation(fields: [babyId], references: [id])
  createdBy User?    @relation("BabyCardPurchasesCreated", fields: [createdById], references: [id])

  rewardUsages BabyCardRewardUsage[]
  sessionLogs  BabyCardSessionLog[]

  @@index([babyId, status])
  @@index([babyCardId])
  @@index([purchaseDate])
  @@index([createdById])
  @@map("baby_card_purchases")
}

// Registro de sesiones completadas en Baby Card
model BabyCardSessionLog {
  id                 String @id @default(cuid())
  babyCardPurchaseId String
  sessionId          String @unique // La sesión que contó
  sessionNumber      Int // Número de sesión en la card (1, 2, 3...)

  createdAt DateTime @default(now())

  babyCardPurchase BabyCardPurchase @relation(fields: [babyCardPurchaseId], references: [id], onDelete: Cascade)
  session          Session          @relation(fields: [sessionId], references: [id])

  @@index([babyCardPurchaseId])
  @@map("baby_card_session_logs")
}

// Uso de premios de Baby Card
model BabyCardRewardUsage {
  id                 String @id @default(cuid())
  babyCardPurchaseId String
  babyCardRewardId   String

  // Cuándo se usó
  usedAt   DateTime @default(now())
  usedById String // Staff que lo aplicó

  // Referencia a dónde se aplicó
  appointmentId      String? // Si se usó en una cita
  eventParticipantId String? // Si se usó en un evento
  productSaleId      String? // Si se usó para un producto

  notes String?

  babyCardPurchase BabyCardPurchase @relation(fields: [babyCardPurchaseId], references: [id], onDelete: Cascade)
  babyCardReward   BabyCardReward   @relation(fields: [babyCardRewardId], references: [id])
  usedBy           User             @relation("BabyCardRewardsApplied", fields: [usedById], references: [id])

  @@unique([babyCardPurchaseId, babyCardRewardId]) // Un premio solo se usa una vez
  @@index([usedById])
  @@index([usedAt])
  @@map("baby_card_reward_usages")
}

// ============================================================
// TRANSACCIONES (Sistema centralizado de pagos)
// ============================================================

// Reemplaza: PaymentDetail, AppointmentPayment, PackagePayment
// Un registro por operación, con split payments en JSON
model Transaction {
  id String @id @default(cuid())

  // Tipo y categoría
  type     TransactionType
  category TransactionCategory

  // Referencia polimórfica
  referenceType String // "Session", "EventParticipant", "PackagePurchase", etc.
  referenceId   String // ID del registro relacionado

  // Totales
  subtotal      Decimal @db.Decimal(10, 2)
  discountTotal Decimal @default(0) @db.Decimal(10, 2)
  total         Decimal @db.Decimal(10, 2)

  // Métodos de pago (split payment support)
  // JSON Array: [{ method: "CASH", amount: 200 }, { method: "QR", amount: 150, reference: "TXN-123" }]
  paymentMethods Json

  // Cash register link (for RECEPTION users)
  cashRegisterId String?
  cashRegister   CashRegister? @relation(fields: [cashRegisterId], references: [id])

  // Metadatos
  notes       String?
  createdById String?
  createdBy   User?    @relation("TransactionsCreated", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  // Line items
  items TransactionItem[]

  // Reversal support
  isReversal   Boolean      @default(false) // true = reversal entry
  reversalOfId String?      @unique           // Points to original Transaction
  reversalOf   Transaction? @relation("TransactionReversal", fields: [reversalOfId], references: [id])
  reversedBy   Transaction? @relation("TransactionReversal") // Inverse: the reversal that voided this

  // Void metadata (set on ORIGINAL after creating reversal, UI-only)
  voidedAt     DateTime?
  voidedById   String?
  voidedBy     User?        @relation("TransactionsVoided", fields: [voidedById], references: [id])
  voidReason   String?

  @@index([type])
  @@index([category])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([isReversal])
  @@index([reversalOfId])
  @@index([cashRegisterId])
  @@index([type, voidedAt, isReversal, createdAt])
  @@index([voidedAt])
  @@index([category, voidedAt, isReversal, referenceType])
  @@map("transactions")
}

// Line items de cada transacción
model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // Tipo y referencia
  itemType    ItemType
  referenceId String? // ID del producto, paquete, etc.
  description String // Nombre legible para reportes

  // Montos
  quantity       Int     @default(1)
  unitPrice      Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  discountReason String?
  finalPrice     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([transactionId])
  @@index([itemType])
  @@map("transaction_items")
}

// ============================================================
// ACTIVIDAD RECIENTE (Auditoría)
// ============================================================

model Activity {
  id String @id @default(cuid())

  // Tipo de actividad
  type ActivityType

  // Descripción (key de traducción)
  title       String // "activity.session_completed"
  description String? // Información adicional

  // Entidad relacionada (para navegación con botón "Ver")
  entityType String? // "appointment", "baby", "session", etc.
  entityId   String? // ID del registro

  // Datos adicionales para UI (JSON flexible)
  metadata Json? // { userName: "María", babyName: "Lucas", amount: 350 }

  // Quién realizó la acción (null si es sistema/portal)
  performedById String?
  performedBy   User?   @relation("ActivitiesPerformed", fields: [performedById], references: [id])

  // Timestamp
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([type, createdAt])
  @@index([performedById, createdAt])
  @@map("activities")
}

// ============================================================
// ARQUEO DE CAJA (Fase 10)
// ============================================================

model CashRegister {
  id String @id @default(cuid())

  // Apertura
  openedById  String
  openedBy    User     @relation("CashRegisterOpenedBy", fields: [openedById], references: [id])
  openedAt    DateTime @default(now())
  initialFund Decimal  @default(0) @db.Decimal(10, 2)

  // Cierre
  closedAt       DateTime?
  declaredAmount Decimal?  @db.Decimal(10, 2)
  expectedAmount Decimal?  @db.Decimal(10, 2)
  difference     Decimal?  @db.Decimal(10, 2)
  closingNotes   String?   @db.Text

  // Estado
  status CashRegisterStatus @default(OPEN)

  // Revisión (solo si hay diferencia)
  reviewedById String?
  reviewedBy   User?     @relation("CashRegisterReviewedBy", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?   @db.Text

  // Forzar cierre (si aplica)
  forcedCloseById  String?
  forcedCloseBy    User?   @relation("CashRegisterForcedBy", fields: [forcedCloseById], references: [id])
  forcedCloseNotes String? @db.Text

  // Relaciones
  expenses     CashRegisterExpense[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([openedById, openedAt])
  @@index([status])
  @@index([openedAt])
  @@map("cash_registers")
}

model CashRegisterExpense {
  id String @id @default(cuid())

  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)

  amount      Decimal             @db.Decimal(10, 2)
  category    CashExpenseCategory
  description String

  createdById String
  createdBy   User     @relation("CashRegisterExpenseCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([cashRegisterId])
  @@index([createdAt])
  @@index([createdById])
  @@map("cash_register_expenses")
}

// ============================================================
// FASE 11 - CRON JOBS Y MENSAJERÍA AUTOMATIZADA
// ============================================================

// Templates de mensajes editables
model MessageTemplate {
  id String @id @default(cuid())

  key         String           @unique // "APPOINTMENT_REMINDER_24H"
  name        String // "Recordatorio de cita 24h"
  description String?
  category    TemplateCategory

  // Canales habilitados
  emailEnabled    Boolean @default(false)
  whatsappEnabled Boolean @default(false)

  // Contenido
  subject String? // Asunto del email
  body    String  @db.Text // Cuerpo del mensaje

  // Para mesversarios: múltiples versiones que rotan
  bodyVersion2 String? @db.Text
  bodyVersion3 String? @db.Text

  // Variables disponibles para este template
  variables String[] @default([]) // ["parentName", "babyName", "date"]

  // Configuración adicional (JSON)
  config Json? // { maxAgeMonths: 12, daysBefore: 3 }

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("message_templates")
}

// Cola de mensajes WhatsApp pendientes
model PendingMessage {
  id String @id @default(cuid())

  // Categoría y template
  category    PendingMessageCategory
  templateKey String

  // Destinatario
  recipientType  RecipientType
  recipientId    String // parentId, babyId, o leadId
  recipientName  String
  recipientPhone String

  // Mensaje ya procesado con variables
  message String @db.Text

  // Entidad relacionada (para navegación)
  entityType String? // "Appointment", "Baby", etc.
  entityId   String?
  metadata   Json? // Datos adicionales

  // Estado
  status     PendingMessageStatus @default(PENDING)
  sentAt     DateTime?
  sentById   String?
  sentBy     User?                @relation("PendingMessageSentBy", fields: [sentById], references: [id])
  skipReason String?

  // Programación
  scheduledFor DateTime // Cuándo debe mostrarse
  expiresAt    DateTime // Cuándo expira (3 días después)

  createdAt DateTime @default(now())

  @@index([status, scheduledFor])
  @@index([category, status])
  @@map("pending_messages")
}

// Log de emails enviados (para tracking con webhooks Resend)
model EmailLog {
  id String @id @default(cuid())

  // ID de Resend para webhooks
  resendId String @unique

  // Destinatario
  toEmail  String
  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id])

  // Template usado
  templateKey String
  category    TemplateCategory

  // Estado (actualizado por webhooks)
  status EmailStatus @default(SENT)

  // Timestamps de eventos
  sentAt       DateTime  @default(now())
  deliveredAt  DateTime?
  openedAt     DateTime?
  bouncedAt    DateTime?
  complainedAt DateTime?

  // Información de rebote
  bounceType   String? // "hard", "soft"
  bounceReason String?

  // Contenido (para referencia)
  subject String?

  // Retry para emails fallidos
  retryCount  Int       @default(0)
  lastRetryAt DateTime?

  createdAt DateTime @default(now())

  @@index([status, createdAt])
  @@index([templateKey, createdAt])
  @@index([parentId])
  @@map("email_logs")
}
