// ============================================================
// BABY SPA - PRISMA SCHEMA
// Sistema de Gestión para Spa de Bebés (Bolivia & Brasil)
// ============================================================

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  OWNER      // Socios - acceso total al sistema
  ADMIN      // Administrador contratado - operaciones + finanzas limitadas
  RECEPTION  // Recepcionista - operaciones diarias
  THERAPIST  // Terapeuta - solo su agenda
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BirthType {
  NATURAL
  CESAREAN
}

enum AppointmentStatus {
  PENDING_PAYMENT  // Waiting for advance payment
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum SessionStatus {
  PENDING
  EVALUATED
  COMPLETED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  OTHER
}

// Tipos de pago a staff (más específicos)
enum StaffPaymentType {
  // Movimientos positivos (ingresos para el empleado)
  SALARY          // Sueldo del período
  COMMISSION      // Comisión
  BONUS           // Bono / Horas extra
  BENEFIT         // Aguinaldo / Viáticos / Beneficios
  SETTLEMENT      // Liquidación
  ADVANCE         // Adelanto (aumenta deuda, pero es ingreso)

  // Movimientos negativos (descuentos para el empleado)
  DEDUCTION       // Descuento (faltas, tardanzas, etc.)
  ADVANCE_RETURN  // Devolución de adelanto (reduce deuda)
}

// Estado del movimiento/pago
enum PaymentStatus {
  PENDING         // Movimiento registrado, pendiente de pago
  PAID            // Pago realizado / Movimiento incluido en pago
}

// Frecuencia de pago del empleado
enum PayFrequency {
  DAILY           // Diario
  WEEKLY          // Semanal
  BIWEEKLY        // Quincenal
  MONTHLY         // Mensual
}

// Categorías de gastos administrativos
enum ExpenseCategory {
  RENT            // Alquiler
  UTILITIES       // Servicios (agua, luz, internet)
  SUPPLIES        // Insumos
  MAINTENANCE     // Mantenimiento / Reparaciones
  MARKETING       // Marketing / Publicidad
  TAXES           // Impuestos / Contabilidad
  INSURANCE       // Seguros
  EQUIPMENT       // Equipos / Mobiliario
  OTHER           // Otros
}

enum MovementType {
  PURCHASE
  SALE
  USAGE
  ADJUSTMENT
}

// Tipo de servicio (para paquetes)
enum ServiceType {
  BABY      // Servicio para bebés (hidroterapia, vacunas, etc.)
  PARENT    // Servicio para padres (masaje prenatal, postparto, etc.)
}

// ============================================================
// ENUMS PARA EVENTOS GRUPALES
// ============================================================

enum ParentStatus {
  LEAD      // Padre potencial (embarazada sin bebé)
  ACTIVE    // Cliente activo
  INACTIVE  // Cliente inactivo
}

enum EventType {
  BABIES    // Eventos para bebés (Hora de Juego, Babython)
  PARENTS   // Eventos para padres/leads (Talleres prenatales)
}

enum EventStatus {
  DRAFT       // Borrador, no visible públicamente
  PUBLISHED   // Publicado, abierto para inscripciones
  IN_PROGRESS // En curso
  COMPLETED   // Finalizado
  CANCELLED   // Cancelado
}

enum ParticipantStatus {
  REGISTERED  // Registrado/inscrito
  CONFIRMED   // Confirmado (pagó o cortesía)
  CANCELLED   // Canceló participación
  NO_SHOW     // No asistió
}

enum DiscountType {
  COURTESY  // Gratis (100% descuento)
  FIXED     // Descuento fijo en monto
}

enum MuscleTone {
  LOW
  NORMAL
  TENSE
}

// ============================================================
// ENUMS PARA BABY CARD (Sistema de Fidelización)
// ============================================================

enum RewardType {
  SERVICE   // Un paquete/servicio gratis
  PRODUCT   // Un producto físico gratis
  EVENT     // Acceso gratis a evento
  CUSTOM    // Premio personalizado (solo texto/diploma/etc.)
}

enum BabyCardStatus {
  ACTIVE      // En progreso
  COMPLETED   // Completó todas las sesiones
  REPLACED    // Fue reemplazada por otra card
  CANCELLED   // Cancelada/reembolsada
}

// Tipos de padre para PaymentDetail (referencia polimórfica)
enum PaymentParentType {
  SESSION               // Pago de sesión (checkout)
  BABY_CARD             // Compra de Baby Card
  EVENT_PARTICIPANT     // Pago de evento
  APPOINTMENT           // Pago anticipado de cita
  PACKAGE_INSTALLMENT   // Cuota de paquete
  STAFF_PAYMENT         // Pago a empleado
  EXPENSE               // Gasto administrativo
}

enum Mood {
  CALM
  IRRITABLE
}

// Para NotificationLog (notificaciones a padres)
enum NotificationLogType {
  MESVERSARY
  BIRTHDAY
  APPOINTMENT_24H
  PATTERN_REMINDER
  INACTIVE_CLIENT
}

// Para Notification (notificaciones en tiempo real al staff)
enum StaffNotificationType {
  NEW_APPOINTMENT           // Cita agendada desde portal
  CANCELLED_APPOINTMENT     // Cita cancelada desde portal
  RESCHEDULED_APPOINTMENT   // Cita reagendada desde portal
}

// Para Activity (registro de actividad/auditoría)
enum ActivityType {
  // Sesiones
  SESSION_COMPLETED
  DISCOUNT_APPLIED

  // Citas
  APPOINTMENT_CREATED
  APPOINTMENT_CREATED_PORTAL
  APPOINTMENT_CANCELLED
  APPOINTMENT_CANCELLED_PORTAL
  APPOINTMENT_RESCHEDULED
  APPOINTMENT_RESCHEDULED_PORTAL

  // Baby Card
  BABY_CARD_SOLD
  BABY_CARD_REWARD_DELIVERED

  // Pagos
  INSTALLMENT_PAID

  // Caja (se integrarán en Fase 9)
  CASH_REGISTER_OPENED
  CASH_REGISTER_CLOSED

  // Eventos
  EVENT_REGISTRATION

  // Bebés y Clientes
  BABY_CREATED
  PACKAGE_ASSIGNED
  CLIENT_UPDATED

  // Evaluaciones (Terapeutas)
  EVALUATION_SAVED

  // Staff Payments y Gastos (Fase 7)
  STAFF_PAYMENT_REGISTERED
  EXPENSE_REGISTERED
}

// ============================================================
// USUARIOS DEL SISTEMA (Staff)
// ============================================================

model User {
  id                 String    @id @default(cuid())
  username           String    @unique
  email              String?
  passwordHash       String
  name               String
  role               UserRole
  phone              String?
  isActive           Boolean   @default(true)
  mustChangePassword Boolean   @default(true) // Forzar cambio en primer login

  // Para control de sueldos
  baseSalary   Decimal?      @db.Decimal(10, 2)
  payFrequency PayFrequency  @default(MONTHLY)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  sessionsAsTherapist        Session[]
  appointmentsAssigned       Appointment[]
  registrationLinks          RegistrationLink[]
  babyNotes                  BabyNote[]
  staffPaymentsReceived      StaffPayment[]        @relation("StaffPaymentsReceived")
  staffPaymentsCreated       StaffPayment[]        @relation("StaffPaymentsCreated")
  staffPaymentsDeleted       StaffPayment[]        @relation("StaffPaymentsDeleted")
  advanceBalance             StaffAdvanceBalance?
  appointmentPayments        AppointmentPayment[]
  packagePayments            PackagePayment[]
  createdEvents              Event[]
  registeredParticipants     EventParticipant[]
  babyCardPurchasesCreated   BabyCardPurchase[]    @relation("BabyCardPurchasesCreated")
  babyCardRewardsApplied     BabyCardRewardUsage[] @relation("BabyCardRewardsApplied")
  paymentDetailsCreated      PaymentDetail[]       @relation("PaymentDetailsCreated")
  notificationsRead          Notification[]        @relation("NotificationReadBy")
  activitiesPerformed        Activity[]            @relation("ActivitiesPerformed")
  expensesCreated            Expense[]             @relation("ExpensesCreated")
  expensesDeleted            Expense[]             @relation("ExpensesDeleted")

  @@map("users")
}

// ============================================================
// PADRES / TUTORES
// ============================================================

model Parent {
  id String @id @default(cuid())

  // Identificador único (opcional para padre/tutor secundario)
  phone String? @unique

  name      String
  email     String?
  birthDate DateTime?

  // Acceso al portal
  accessCode String @unique // BSB-XXXXX

  // Sistema de penalización
  noShowCount        Int       @default(0)
  requiresPrepayment Boolean   @default(false)
  lastNoShowDate     DateTime?

  // Status y campos LEAD (para talleres prenatales)
  status              ParentStatus  @default(ACTIVE)
  pregnancyWeeks      Int?          // Semanas de embarazo (para LEADs)
  leadSource          String?       // Fuente del lead (Instagram, Referido, etc.)
  leadNotes           String?       // Notas sobre el lead
  convertedAt         DateTime?     // Fecha en que pasó de LEAD a ACTIVE

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  babies                BabyParent[]
  waitlistItems         Waitlist[]
  eventParticipations   EventParticipant[]

  // Servicios para el padre (masaje prenatal, postparto, etc.)
  appointments          Appointment[]
  packagePurchases      PackagePurchase[]

  @@map("parents")
}

// ============================================================
// BEBÉS
// ============================================================

model Baby {
  id String @id @default(cuid())

  name      String
  birthDate DateTime
  gender    Gender

  // Datos de nacimiento
  birthWeeks  Int?
  birthWeight Decimal?  @db.Decimal(4, 2)
  birthType   BirthType?

  // Datos médicos
  birthDifficulty          Boolean  @default(false)
  birthDifficultyDesc      String?
  pregnancyIssues          Boolean  @default(false)
  pregnancyIssuesDesc      String?
  priorStimulation         Boolean  @default(false)
  priorStimulationType     String?
  developmentDiagnosis     Boolean  @default(false)
  developmentDiagnosisDesc String?
  diagnosedIllness         Boolean  @default(false)
  diagnosedIllnessDesc     String?
  recentMedication         Boolean  @default(false)
  recentMedicationDesc     String?
  allergies                String?
  specialObservations      String?

  // Autorizaciones
  socialMediaConsent Boolean @default(false)
  instagramHandle    String?

  // Marketing
  referralSource String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parents               BabyParent[]
  packagePurchases      PackagePurchase[]
  appointments          Appointment[]
  sessions              Session[]
  notifications         NotificationLog[]
  notes                 BabyNote[]
  eventParticipations   EventParticipant[]
  babyCardPurchases     BabyCardPurchase[]

  @@map("babies")
}

// ============================================================
// RELACIÓN BEBÉ - PADRE (N:M)
// ============================================================

model BabyParent {
  id           String  @id @default(cuid())
  babyId       String
  baby         Baby    @relation(fields: [babyId], references: [id], onDelete: Cascade)
  parentId     String
  parent       Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  relationship String  @default("MOTHER")
  isPrimary    Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([babyId, parentId])
  // Performance indexes
  @@index([babyId, isPrimary])
  @@index([parentId, isPrimary])
  @@map("baby_parents")
}

// ============================================================
// NOTAS INTERNAS DEL BEBÉ
// ============================================================

model BabyNote {
  id     String @id @default(cuid())
  babyId String
  baby   Baby   @relation(fields: [babyId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id])
  note   String

  createdAt DateTime @default(now())

  @@map("baby_notes")
}

// ============================================================
// LINK REGISTRO TEMPORAL
// ============================================================

model RegistrationLink {
  id          String    @id @default(cuid())
  token       String    @unique

  // Datos pre-llenados por recepción (solo teléfono requerido)
  parentName  String?
  parentPhone String

  expiresAt   DateTime  // 5 días desde creación
  isUsed      Boolean   @default(false)
  usedAt      DateTime?

  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])

  // Referencias al padre y bebé creados (se llenan al completar)
  babyId      String?
  parentId    String?

  createdAt DateTime @default(now())

  @@map("registration_links")
}

// ============================================================
// CATEGORÍAS (para paquetes y productos)
// ============================================================

enum CategoryType {
  PACKAGE
  PRODUCT
}

model Category {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        CategoryType // PACKAGE o PRODUCT
  color       String?      // Color para UI (ej: "teal", "amber")
  sortOrder   Int          @default(0)
  isActive    Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packages Package[]
  products Product[]

  @@unique([name, type])
  @@map("categories")
}

// ============================================================
// CATÁLOGO DE PAQUETES
// ============================================================

model Package {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Tipo de servicio: para bebés o para padres
  serviceType ServiceType @default(BABY)

  // Relación con categoría
  categoryId  String?
  categoryRef Category? @relation(fields: [categoryId], references: [id])
  sessionCount   Int
  basePrice      Decimal @db.Decimal(10, 2)

  // Duración y pago anticipado
  duration                Int       @default(60)           // Duración en minutos
  requiresAdvancePayment  Boolean   @default(false)        // Requiere pago anticipado
  advancePaymentAmount    Decimal?  @db.Decimal(10, 2)     // Monto del anticipo

  // Configuración de cuotas (definidas por el admin)
  allowInstallments           Boolean   @default(false)         // ¿Permite pago en cuotas?
  installmentsCount           Int?                              // Cantidad de cuotas: 3
  installmentsTotalPrice      Decimal?  @db.Decimal(10, 2)      // Precio total en cuotas (puede ser mayor)
  installmentsPayOnSessions   String?                           // En qué sesiones pagar: "1,3,5"

  isActive       Boolean @default(true)
  isPublic       Boolean @default(true)  // false = solo para premios Baby Card y uso interno
  sortOrder      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases             PackagePurchase[]
  appointments          Appointment[]       // Citas que tienen este paquete pre-seleccionado
  systemSettings        SystemSettings[]    @relation("DefaultPackage")
  babyCardSpecialPrices BabyCardSpecialPrice[]
  babyCardRewards       BabyCardReward[]

  @@map("packages")
}

// ============================================================
// COMPRA DE PAQUETE
// ============================================================

model PackagePurchase {
  id        String  @id @default(cuid())

  // Cliente: bebé O padre (según serviceType del paquete)
  babyId    String?
  baby      Baby?   @relation(fields: [babyId], references: [id])
  parentId  String?
  parent    Parent? @relation(fields: [parentId], references: [id])

  packageId String
  package   Package @relation(fields: [packageId], references: [id])

  basePrice      Decimal  @db.Decimal(10, 2)
  discountAmount Decimal  @default(0) @db.Decimal(10, 2)
  discountReason String?
  finalPrice     Decimal  @db.Decimal(10, 2)

  totalSessions     Int
  usedSessions      Int @default(0)
  remainingSessions Int

  // Patrón de visitas
  visitPattern  String? // FIXED_DAY, FREQUENCY, IRREGULAR
  fixedDay      Int? // 0-6 si FIXED_DAY
  frequencyDays Int? // Cada X días si FREQUENCY

  // Financiamiento - Pago en cuotas
  paymentPlan                String    @default("SINGLE")      // SINGLE | INSTALLMENTS
  installments               Int       @default(1)             // Número de cuotas (1 = pago único)
  totalPrice                 Decimal?  @db.Decimal(10, 2)      // Precio total a pagar (único o cuotas) - null usa finalPrice
  installmentAmount          Decimal?  @db.Decimal(10, 2)      // Monto por cuota
  paidAmount                 Decimal   @default(0) @db.Decimal(10, 2)  // Total pagado hasta ahora
  installmentsPayOnSessions  String?                           // Copiado del paquete: "1,3,5"

  // Preferencia de horario del padre (para auto-agendado masivo)
  // Formato JSON: [{"dayOfWeek": 1, "time": "09:00"}, {"dayOfWeek": 4, "time": "15:00"}]
  schedulePreferences        String?   @db.Text

  isActive Boolean @default(true)

  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions           Session[]
  appointments       Appointment[]
  installmentPayments PackagePayment[]

  // Performance indexes
  @@index([babyId, isActive])
  @@index([parentId, isActive])
  @@map("package_purchases")
}

// ============================================================
// CITAS (Agendamiento)
// ============================================================

model Appointment {
  id     String @id @default(cuid())

  // Cliente: bebé O padre (según serviceType del paquete)
  babyId   String?
  baby     Baby?   @relation(fields: [babyId], references: [id])
  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id])

  // Paquete seleccionado (provisional hasta checkout)
  // Si el bebé tiene paquete comprado -> usa packagePurchaseId
  // Si selecciona del catálogo -> usa selectedPackageId
  selectedPackageId   String?          // Paquete del catálogo (provisional)
  selectedPackage     Package?         @relation(fields: [selectedPackageId], references: [id])
  packagePurchaseId   String?          // Paquete comprado existente
  packagePurchase     PackagePurchase? @relation(fields: [packagePurchaseId], references: [id])

  // Fecha sin componente de hora (evita problemas de timezone)
  date      DateTime @db.Date
  // Horas como strings simples "09:00", "09:30", "14:30" (sin timezone)
  startTime String   // HH:mm format
  endTime   String   // HH:mm format

  status AppointmentStatus @default(SCHEDULED)

  // Terapeuta asignado (se asigna al iniciar la cita)
  therapistId String?
  therapist   User?   @relation(fields: [therapistId], references: [id])

  // Indica si el terapeuta registró la evaluación (independiente del status)
  isEvaluated Boolean @default(false)

  reminder24hSent   Boolean   @default(false)
  reminder24hSentAt DateTime?

  notes        String?
  cancelReason String?

  // For advance payment tracking
  isPendingPayment Boolean @default(false)

  // Pending schedule preferences (from portal, before checkout)
  // Transferred to PackagePurchase.schedulePreferences when completed
  pendingSchedulePreferences String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session  Session?
  history  AppointmentHistory[]
  payments AppointmentPayment[]

  // Performance indexes
  @@index([date, status])
  @@index([babyId, status])
  @@index([therapistId, date, status])
  @@index([parentId, date, status])
  @@index([status])
  @@index([isPendingPayment])
  @@map("appointments")
}

// ============================================================
// HISTORIAL DE CAMBIOS DE CITA
// ============================================================

model AppointmentHistory {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  action        String // CREATED, RESCHEDULED, CANCELLED, COMPLETED, NO_SHOW
  performedBy   String // user_id o parent_id
  performerType String // USER o PARENT
  performerName String

  oldValue Json?
  newValue Json?
  reason   String?

  createdAt DateTime @default(now())

  @@map("appointment_history")
}

// ============================================================
// PAGOS DE CITAS (Anticipos y pagos parciales)
// ============================================================

model AppointmentPayment {
  id            String        @id @default(cuid())
  appointmentId String
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  paymentType   String        // ADVANCE | COMPLETION | PARTIAL
  reference     String?       // Receipt/transaction number
  notes         String?

  createdAt   DateTime @default(now())
  createdById String

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  createdBy   User        @relation(fields: [createdById], references: [id])

  @@map("appointment_payments")
}

// ============================================================
// LISTA DE ESPERA
// ============================================================

model Waitlist {
  id       String @id @default(cuid())
  babyId   String
  parentId String
  parent   Parent @relation(fields: [parentId], references: [id])

  desiredDate DateTime @db.Date
  desiredTime String   // HH:mm format

  notified   Boolean   @default(false)
  notifiedAt DateTime?
  expiresAt  DateTime

  createdAt DateTime @default(now())

  @@map("waitlist")
}

// ============================================================
// SESIONES (Ejecución)
// ============================================================

model Session {
  id                String           @id @default(cuid())
  appointmentId     String           @unique
  appointment       Appointment      @relation(fields: [appointmentId], references: [id])
  babyId            String?          // Optional: null for parent-only appointments
  baby              Baby?            @relation(fields: [babyId], references: [id])
  therapistId       String
  therapist         User             @relation(fields: [therapistId], references: [id])
  packagePurchaseId String?
  packagePurchase   PackagePurchase? @relation(fields: [packagePurchaseId], references: [id])

  sessionNumber Int
  status        SessionStatus @default(PENDING)

  startedAt   DateTime?
  evaluatedAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  evaluation         Evaluation?
  products           SessionProduct[]
  payment            Payment?
  babyCardSessionLog BabyCardSessionLog?

  // Performance indexes
  @@index([therapistId, status])
  @@index([babyId, status])
  @@index([packagePurchaseId, status])
  @@index([status])
  @@map("sessions")
}

// ============================================================
// EVALUACIÓN DE SESIÓN
// ============================================================

model Evaluation {
  id        String  @id @default(cuid())
  sessionId String  @unique
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  babyAgeMonths Int
  babyWeight    Decimal? @db.Decimal(4, 2)

  // Actividades realizadas en la sesión
  hydrotherapy       Boolean @default(false)
  massage            Boolean @default(false)
  motorStimulation   Boolean @default(false)
  sensoryStimulation Boolean @default(false)
  relaxation         Boolean @default(false)
  otherActivities    String? // Otras actividades (texto libre)

  // Evaluación sensorial
  visualTracking   Boolean?
  eyeContact       Boolean?
  auditoryResponse Boolean?

  // Desarrollo muscular
  muscleTone      MuscleTone?
  cervicalControl Boolean?
  headUp          Boolean?

  // Hitos
  sits   Boolean?
  crawls Boolean?
  walks  Boolean?

  // Estado
  mood Mood?

  // Comentarios
  internalNotes String? // Solo visible para staff
  externalNotes String? // Visible para padres

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("evaluations")
}

// ============================================================
// PRODUCTOS (Inventario)
// ============================================================

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Relación con categoría
  categoryId  String?
  categoryRef Category? @relation(fields: [categoryId], references: [id])

  costPrice      Decimal @db.Decimal(10, 2)
  salePrice      Decimal @db.Decimal(10, 2)
  currentStock   Int     @default(0)
  minStock       Int     @default(5)
  isActive       Boolean @default(true)

  // Valor por defecto cuando se usa en sesiones
  isChargeableByDefault Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movements       InventoryMovement[]
  sessionUsages   SessionProduct[]
  eventUsages     EventProductUsage[]
  babyCardRewards BabyCardReward[]

  @@map("products")
}

// ============================================================
// MOVIMIENTOS DE INVENTARIO
// ============================================================

model InventoryMovement {
  id          String       @id @default(cuid())
  productId   String
  product     Product      @relation(fields: [productId], references: [id])
  type        MovementType
  quantity    Int
  unitPrice   Decimal      @db.Decimal(10, 2)
  totalAmount Decimal      @db.Decimal(10, 2)
  notes       String?
  stockAfter  Int

  createdAt DateTime @default(now())

  @@map("inventory_movements")
}

// ============================================================
// PRODUCTOS USADOS EN SESIÓN
// ============================================================

model SessionProduct {
  id           String  @id @default(cuid())
  sessionId    String
  session      Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  productId    String
  product      Product @relation(fields: [productId], references: [id])
  quantity     Int     @default(1)
  unitPrice    Decimal @db.Decimal(10, 2)
  isChargeable Boolean @default(false)

  createdAt DateTime @default(now())

  @@map("session_products")
}

// ============================================================
// PAGOS
// ============================================================

model Payment {
  id              String           @id @default(cuid())
  sessionId       String?          @unique
  session         Session?         @relation(fields: [sessionId], references: [id])
  packagePurchase PackagePurchase?
  amount          Decimal          @db.Decimal(10, 2)
  method          PaymentMethod
  notes           String?

  createdAt DateTime @default(now())

  @@map("payments")
}

// ============================================================
// PAGOS DE CUOTAS DE PAQUETES
// ============================================================

model PackagePayment {
  id                  String          @id @default(cuid())
  packagePurchaseId   String
  packagePurchase     PackagePurchase @relation(fields: [packagePurchaseId], references: [id], onDelete: Cascade)
  installmentNumber   Int             // 1, 2, 3, 4... (número de cuota)
  amount              Decimal         @db.Decimal(10, 2)
  paymentMethod       PaymentMethod
  reference           String?         // Número de comprobante
  notes               String?

  paidAt              DateTime        @default(now())
  createdById         String
  createdBy           User            @relation(fields: [createdById], references: [id])

  @@index([packagePurchaseId])
  @@map("package_payments")
}

// ============================================================
// PAGOS AL PERSONAL
// ============================================================

model StaffPayment {
  id              String            @id @default(cuid())

  // Empleado que recibe el pago
  staffId         String
  staff           User              @relation("StaffPaymentsReceived", fields: [staffId], references: [id])

  // Tipo y estado
  type            StaffPaymentType
  status          PaymentStatus     @default(PENDING)

  // Montos
  grossAmount     Decimal           @db.Decimal(10, 2)  // Monto bruto (puede ser negativo para deducciones)
  netAmount       Decimal           @db.Decimal(10, 2)  // Monto neto (después de descuentos de adelanto)

  // Descuento de adelanto (solo aplica para SALARY)
  advanceDeducted Decimal?          @db.Decimal(10, 2)  // Monto descontado de adelanto

  // Descripción
  description     String

  // Período de pago (fechas flexibles para cualquier frecuencia)
  periodStart     DateTime?         // Inicio del período (nullable para migración)
  periodEnd       DateTime?         // Fin del período (nullable para migración)
  movementDate    DateTime?         // Fecha específica del movimiento (ej: día de la falta)

  // Campos legacy (para compatibilidad)
  periodMonth     Int?              // Mes del período (1-12)
  periodYear      Int?              // Año del período

  // Fecha del pago real (null si es movimiento pendiente)
  paidAt          DateTime?

  // Referencia al pago de salario que incluyó este movimiento (para trazabilidad)
  includedInSalaryId String?
  includedInSalary   StaffPayment?  @relation("MovementsIncludedInSalary", fields: [includedInSalaryId], references: [id])
  includedMovements  StaffPayment[] @relation("MovementsIncludedInSalary")

  // Auditoría
  createdById     String
  createdBy       User              @relation("StaffPaymentsCreated", fields: [createdById], references: [id])
  createdAt       DateTime          @default(now())

  // Soft delete
  deletedAt       DateTime?
  deletedById     String?
  deletedBy       User?             @relation("StaffPaymentsDeleted", fields: [deletedById], references: [id])

  @@index([staffId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([type])
  @@index([deletedAt])
  @@map("staff_payments")
}

// ============================================================
// CONTROL DE ADELANTOS PENDIENTES
// ============================================================

model StaffAdvanceBalance {
  id              String    @id @default(cuid())

  staffId         String    @unique
  staff           User      @relation(fields: [staffId], references: [id])

  currentBalance  Decimal   @db.Decimal(10, 2) @default(0)  // Saldo pendiente de adelanto

  updatedAt       DateTime  @updatedAt

  @@map("staff_advance_balances")
}

// ============================================================
// GASTOS ADMINISTRATIVOS
// ============================================================

model Expense {
  id              String          @id @default(cuid())

  // Categoría y descripción
  category        ExpenseCategory
  description     String

  // Monto
  amount          Decimal         @db.Decimal(10, 2)

  // Referencia/comprobante
  reference       String?         // Número de factura, etc.

  // Fecha del gasto
  expenseDate     DateTime        @db.Date @default(now())

  // Auditoría
  createdById     String
  createdBy       User            @relation("ExpensesCreated", fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())

  // Soft delete
  deletedAt       DateTime?
  deletedById     String?
  deletedBy       User?           @relation("ExpensesDeleted", fields: [deletedById], references: [id])

  @@index([expenseDate])
  @@index([category])
  @@index([deletedAt])
  @@map("expenses")
}

// ============================================================
// LOG DE NOTIFICACIONES
// ============================================================

model NotificationLog {
  id                  String              @id @default(cuid())
  babyId              String
  baby                Baby                @relation(fields: [babyId], references: [id])
  type                NotificationLogType
  emailSent           Boolean             @default(false)
  emailSentAt         DateTime?
  whatsappContacted   Boolean             @default(false)
  whatsappContactedAt DateTime?
  metadata            Json?

  createdAt DateTime @default(now())

  @@map("notification_logs")
}

// ============================================================
// NOTIFICACIONES EN TIEMPO REAL (Staff)
// ============================================================

model Notification {
  id            String                 @id @default(cuid())

  // Tipo y contenido
  type          StaffNotificationType
  title         String
  message       String

  // Referencia para navegación
  entityType    String?                // "appointment"
  entityId      String?                // ID de la cita

  // Datos adicionales para navegación
  metadata      Json?                  // { date: "2026-01-28", isPendingPayment: true }

  // Estado de lectura (compartido entre staff)
  isRead        Boolean                @default(false)
  readAt        DateTime?
  readById      String?
  readBy        User?                  @relation("NotificationReadBy", fields: [readById], references: [id])

  // Audiencia
  forRole       UserRole               @default(RECEPTION)

  // Timestamps
  createdAt     DateTime               @default(now())
  expiresAt     DateTime               // createdAt + 7 días

  @@index([isRead, forRole])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================
// CONFIGURACIÓN DEL SISTEMA
// ============================================================

model SystemConfig {
  id          String  @id @default(cuid())
  key         String  @unique
  value       String
  description String?

  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ============================================================
// HORARIOS DE ATENCIÓN
// ============================================================

model BusinessHours {
  id             String   @id @default(cuid())
  dayOfWeek      Int      // 0=Dom, 1=Lun, ..., 6=Sab
  morningOpen    String?  // HH:mm format
  morningClose   String?  // HH:mm format
  afternoonOpen  String?  // HH:mm format
  afternoonClose String?  // HH:mm format
  isOpen         Boolean  @default(true)

  @@unique([dayOfWeek])
  @@map("business_hours")
}

// ============================================================
// DÍAS CERRADOS
// ============================================================

model ClosedDate {
  id     String   @id @default(cuid())
  date   DateTime @db.Date
  reason String?

  @@unique([date])
  @@map("closed_dates")
}

// ============================================================
// CONFIGURACIÓN GLOBAL DEL SISTEMA
// ============================================================

model SystemSettings {
  id                    String   @id @default("default")

  // Paquete por defecto para citas sin paquete
  defaultPackageId      String?
  defaultPackage        Package? @relation("DefaultPackage", fields: [defaultPackageId], references: [id])

  // Configuración de pagos (para Fase 3.2)
  paymentQrImage        String?  @db.Text  // Base64 encoded QR image
  paymentQrImageUrl     String?  // URL de la imagen del QR de pago (legacy)
  whatsappNumber        String?  // Número de WhatsApp para comprobantes
  whatsappCountryCode   String?  @default("+591")  // Country code for WhatsApp
  whatsappMessage       String?  @default("Hola, adjunto mi comprobante de pago para la cita del {fecha} a las {hora}. Bebé: {bebe}")

  // Configuración de notificaciones
  notificationPollingInterval  Int @default(5)   // Intervalo de polling en minutos (1-30)
  notificationExpirationDays   Int @default(7)   // Días hasta que expira una notificación (1-30)

  updatedAt             DateTime @updatedAt

  @@map("system_settings")
}

// ============================================================
// EVENTOS GRUPALES
// ============================================================

model Event {
  id          String      @id @default(cuid())
  name        String
  description String?
  type        EventType   // BABIES o PARENTS

  // Fecha y horario
  date        DateTime    @db.Date
  startTime   String      // HH:mm format
  endTime     String      // HH:mm format

  // Capacidad y bloqueo
  maxParticipants    Int       @default(10)
  blockedTherapists  Int       @default(0)  // 0-4: cuántos terapeutas se bloquean

  // Rango de edad (solo para eventos tipo BABIES)
  minAgeMonths       Int?      // Edad mínima en meses
  maxAgeMonths       Int?      // Edad máxima en meses

  // Precio y descuentos
  basePrice          Decimal   @db.Decimal(10, 2)

  status      EventStatus @default(DRAFT)

  // Notas
  internalNotes  String?   // Solo visible para staff
  externalNotes  String?   // Visible para padres (descripción pública)

  // Auditoría
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  participants  EventParticipant[]
  productUsages EventProductUsage[]

  @@map("events")
}

// ============================================================
// PARTICIPANTES DE EVENTOS
// ============================================================

model EventParticipant {
  id        String            @id @default(cuid())
  eventId   String
  event     Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Participante: bebé O padre (mutuamente excluyentes según tipo evento)
  babyId    String?
  baby      Baby?             @relation(fields: [babyId], references: [id])
  parentId  String?
  parent    Parent?           @relation(fields: [parentId], references: [id])

  status    ParticipantStatus @default(REGISTERED)

  // Descuentos individuales por participante
  discountType    DiscountType?   // COURTESY o FIXED
  discountAmount  Decimal?        @db.Decimal(10, 2)  // Monto si es FIXED
  discountReason  String?         // Razón del descuento

  // Pago
  amountDue       Decimal         @db.Decimal(10, 2)  // Monto a pagar (precio - descuento)
  amountPaid      Decimal         @default(0) @db.Decimal(10, 2)
  paymentMethod   PaymentMethod?
  paymentReference String?
  paidAt          DateTime?

  // Asistencia
  attended        Boolean?        // null = no marcado, true = asistió, false = no asistió
  attendedAt      DateTime?

  // Notas
  notes           String?

  // Auditoría
  registeredById  String
  registeredBy    User            @relation(fields: [registeredById], references: [id])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([eventId, babyId])
  @@unique([eventId, parentId])
  // Performance indexes
  @@index([eventId, status])
  @@index([babyId, status])
  @@index([parentId, status])
  @@map("event_participants")
}

// ============================================================
// PRODUCTOS USADOS EN EVENTOS
// ============================================================

model EventProductUsage {
  id          String    @id @default(cuid())
  eventId     String
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  productId   String
  product     Product   @relation(fields: [productId], references: [id])

  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(10, 2)
  notes       String?

  createdAt   DateTime  @default(now())

  @@map("event_product_usages")
}

// ============================================================
// BABY CARD - SISTEMA DE FIDELIZACIÓN
// ============================================================

// Plantilla/Catálogo de Baby Cards
model BabyCard {
  id                    String    @id @default(cuid())
  name                  String    // "Baby Spa Card Premium"
  description           String?   @db.Text

  // Precio y configuración
  price                 Decimal   @db.Decimal(10, 2)  // Precio de la tarjeta
  totalSessions         Int       // Total de sesiones para completar
  firstSessionDiscount  Decimal   @default(0) @db.Decimal(10, 2)  // Monto de descuento en primera sesión

  // Estado
  isActive              Boolean   @default(true)
  sortOrder             Int       @default(0)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relaciones
  specialPrices         BabyCardSpecialPrice[]
  rewards               BabyCardReward[]
  purchases             BabyCardPurchase[]

  @@map("baby_cards")
}

// Precios especiales por paquete/servicio
model BabyCardSpecialPrice {
  id              String    @id @default(cuid())
  babyCardId      String
  packageId       String    // Paquete al que aplica (ej: Sesión Individual)
  specialPrice    Decimal   @db.Decimal(10, 2)  // Precio con Baby Card

  babyCard        BabyCard  @relation(fields: [babyCardId], references: [id], onDelete: Cascade)
  package         Package   @relation(fields: [packageId], references: [id])

  @@unique([babyCardId, packageId])
  @@map("baby_card_special_prices")
}

// Premios configurados en cada Baby Card
model BabyCardReward {
  id              String          @id @default(cuid())
  babyCardId      String
  sessionNumber   Int             // En qué sesión se desbloquea (3, 7, 10, etc.)

  // Tipo de premio
  rewardType      RewardType      // SERVICE | PRODUCT | EVENT | CUSTOM

  // Referencias según tipo
  packageId       String?         // Si rewardType = SERVICE
  productId       String?         // Si rewardType = PRODUCT

  // Para premios personalizados (CUSTOM)
  customName      String?         // "Diploma de Graduación"
  customDescription String?       @db.Text

  // Display
  displayName     String          // "Sesión de Fotos Gratis"
  displayIcon     String?         // Emoji o nombre de icono lucide

  createdAt       DateTime        @default(now())

  babyCard        BabyCard        @relation(fields: [babyCardId], references: [id], onDelete: Cascade)
  package         Package?        @relation(fields: [packageId], references: [id])
  product         Product?        @relation(fields: [productId], references: [id])

  usages          BabyCardRewardUsage[]

  @@unique([babyCardId, sessionNumber])
  @@map("baby_card_rewards")
}

// Compra/Asignación de Baby Card a un bebé
model BabyCardPurchase {
  id                    String          @id @default(cuid())
  babyCardId            String
  babyId                String

  // Pago
  pricePaid             Decimal         @db.Decimal(10, 2)
  paymentMethod         PaymentMethod?
  paymentReference      String?

  // Progreso
  completedSessions     Int             @default(0)

  // Estado
  status                BabyCardStatus  @default(ACTIVE)

  // Descuento primera sesión
  firstSessionDiscountUsed    Boolean         @default(false)
  firstSessionDiscountAmount  Decimal?        @db.Decimal(10, 2)  // Monto realmente descontado
  firstSessionDiscountAppliedTo String?       // ID de la cita/paquete donde se aplicó
  firstSessionDiscountDate    DateTime?

  // Fechas
  purchaseDate          DateTime        @default(now())
  completedDate         DateTime?       // Cuando completó todas las sesiones
  replacedDate          DateTime?       // Si fue reemplazada por otra card
  replacedByPurchaseId  String?         // ID de la card que la reemplazó

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  createdById           String?

  // Relaciones
  babyCard              BabyCard        @relation(fields: [babyCardId], references: [id])
  baby                  Baby            @relation(fields: [babyId], references: [id])
  createdBy             User?           @relation("BabyCardPurchasesCreated", fields: [createdById], references: [id])

  rewardUsages          BabyCardRewardUsage[]
  sessionLogs           BabyCardSessionLog[]

  @@map("baby_card_purchases")
}

// Registro de sesiones completadas en Baby Card
model BabyCardSessionLog {
  id                  String    @id @default(cuid())
  babyCardPurchaseId  String
  sessionId           String    @unique  // La sesión que contó
  sessionNumber       Int       // Número de sesión en la card (1, 2, 3...)

  createdAt           DateTime  @default(now())

  babyCardPurchase    BabyCardPurchase @relation(fields: [babyCardPurchaseId], references: [id], onDelete: Cascade)
  session             Session          @relation(fields: [sessionId], references: [id])

  @@map("baby_card_session_logs")
}

// Uso de premios de Baby Card
model BabyCardRewardUsage {
  id                  String    @id @default(cuid())
  babyCardPurchaseId  String
  babyCardRewardId    String

  // Cuándo se usó
  usedAt              DateTime  @default(now())
  usedById            String    // Staff que lo aplicó

  // Referencia a dónde se aplicó
  appointmentId       String?   // Si se usó en una cita
  eventParticipantId  String?   // Si se usó en un evento
  productSaleId       String?   // Si se usó para un producto

  notes               String?

  babyCardPurchase    BabyCardPurchase @relation(fields: [babyCardPurchaseId], references: [id], onDelete: Cascade)
  babyCardReward      BabyCardReward   @relation(fields: [babyCardRewardId], references: [id])
  usedBy              User             @relation("BabyCardRewardsApplied", fields: [usedById], references: [id])

  @@unique([babyCardPurchaseId, babyCardRewardId])  // Un premio solo se usa una vez
  @@map("baby_card_reward_usages")
}

// ============================================================
// DETALLES DE PAGO (Split Payments)
// ============================================================

// Modelo centralizado para registrar cada "línea" de pago
// Permite pagos divididos: ej. 350 Bs = 200 efectivo + 150 tarjeta
model PaymentDetail {
  id              String            @id @default(cuid())

  // Referencia polimórfica al padre
  parentType      PaymentParentType
  parentId        String            // ID del Payment, BabyCardPurchase, EventParticipant, etc.

  // Detalle del pago
  amount          Decimal           @db.Decimal(10, 2)
  paymentMethod   PaymentMethod     // CASH, TRANSFER, CARD, OTHER
  reference       String?           // Número de comprobante

  // Auditoría
  createdAt       DateTime          @default(now())
  createdById     String?
  createdBy       User?             @relation("PaymentDetailsCreated", fields: [createdById], references: [id])

  @@index([parentType, parentId])
  @@map("payment_details")
}

// ============================================================
// ACTIVIDAD RECIENTE (Auditoría)
// ============================================================

model Activity {
  id            String         @id @default(cuid())

  // Tipo de actividad
  type          ActivityType

  // Descripción (key de traducción)
  title         String         // "activity.session_completed"
  description   String?        // Información adicional

  // Entidad relacionada (para navegación con botón "Ver")
  entityType    String?        // "appointment", "baby", "session", etc.
  entityId      String?        // ID del registro

  // Datos adicionales para UI (JSON flexible)
  metadata      Json?          // { userName: "María", babyName: "Lucas", amount: 350 }

  // Quién realizó la acción (null si es sistema/portal)
  performedById String?
  performedBy   User?          @relation("ActivitiesPerformed", fields: [performedById], references: [id])

  // Timestamp
  createdAt     DateTime       @default(now())

  @@index([createdAt])
  @@index([type, createdAt])
  @@index([performedById, createdAt])
  @@map("activities")
}
